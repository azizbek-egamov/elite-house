{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block title %}To'lovlar jadvali - Xorazm Elite House{% endblock title %}

{% block item %}
<div class="app-container">

    <!-- App hero header starts -->
    <div class="app-hero-header d-flex align-items-center">

    <!-- Breadcrumb starts -->
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
        <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
        <a href="/">Asosiy</a>
        </li>
        <li class="breadcrumb-item" aria-current="page">
         <a href="/contract">Shartnomalar</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
        To'lovlar jadvali
        </li>
    </ol>
    <!-- Breadcrumb ends -->

    </div>
    <!-- App Hero header ends -->

    <!-- App body starts -->
    <div class="app-body">
        {% include 'messages.html' %}
    <!-- Row starts -->
    <div class="row gx-3">
      
        <div class="col-12 col-xl-3 col-lg-6 col-md-6 col-sm-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="p-2 border border-primary rounded-circle me-3">
                            <div class="icon-box md bg-primary-subtle rounded-5">
                                <i class="ri-contract-line fs-4 text-primary"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <h4 class="lh-1">#{{contract.contract}}</h4>
                            <p class="m-0">Shartnoma raqami</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3 col-lg-6 col-md-6 col-sm-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="p-2 border border-success rounded-circle me-3">
                            <div class="icon-box md bg-success-subtle rounded-5">
                                <i class="ri-calendar-line fs-4 text-success"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <h4 class="lh-1">{{price|intcomma}} so'm</h4>
                            <p class="m-0">Xonadon narxi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3 col-lg-6 col-md-6 col-sm-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="p-2 border border-danger rounded-circle me-3">
                            <div class="icon-box md bg-danger-subtle rounded-5">
                                <i class="ri-money-dollar-circle-line fs-4 text-danger"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <h4 class="lh-1" id="totalRemainingDebt">Hisoblanmoqda...</h4>
                            <p class="m-0">Qolgan qarz</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-xl-3 col-lg-6 col-md-6 col-sm-6">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="p-2 border border-warning rounded-circle me-3">
                            <div class="icon-box md bg-warning-subtle rounded-5">
                                <i class="ri-refund-2-line fs-4 text-warning"></i>
                            </div>
                        </div>
                        <div class="d-flex flex-column">
                            <h4 class="lh-1">Oyning {{contract.pay_date}} - sanasida </h4>
                            <p class="m-0">To'lov qilish sanasi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="card-title">To'lovlar jadvali</h5>

            <div class="ms-auto">
                <a href="/contract" class="btn btn-outline-secondary">Orqaga</a>
                <button id="customPaymentBtn" class="btn btn-success">Ixtiyoriy to'lov qilish</button>
                <a href="/contract/{{pk}}/list/download/" target="_blank" class="btn btn-primary ms-2">Yuklab olish</a>
            </div>

            </div>
            <div class="card-body">

            <!-- Table starts -->
            <div class="table-responsive table-container">
                <table id="basicExample" class="table table-hover truncate m-0 align-middle">
                <thead>
                    <tr>
                    <th>Oy</th>
                    <th>To'lov miqdori</th>
                    <th>To'langan miqdor</th>
                    <th>Oy uchun qoldiq</th>
                    <th>To'lov sanasi</th>
                    <th>Holati</th>
                    <th>Harakat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in rasrochka %}
                    <tr class="payment-row" data-month="{{i.month}}" data-qoldiq="{{i.qoldiq}}">
                        <td>{% if i.month == 0 %}Boshlang'ich to'lov{% else %}{{i.month}}-oy{% endif %}</td>
                        <td>{{i.amount|intcomma}} so'm</td>
                        <td>{{i.amount_paid|intcomma}} so'm</td>
                        <td>{{i.qoldiq|intcomma}} so'm</td>
                        <td>{{i.date|date:"d.m.Y"}}</td>
                        <td>
                            {% if i.qoldiq > 0 %}
                                <span class="badge bg-warning">To'lanmagan</span>
                            {% elif i.qoldiq == 0 and i.amount > 0 %}
                                <span class="badge bg-success">To'langan</span>
                            {% else %}
                                <span class="badge bg-secondary">Kutilmoqda</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if i.qoldiq > 0 and contract.status != "Tugallangan" %}
                                <button class="btn btn-sm btn-primary make-payment" 
                                        data-month="{{i.month}}" 
                                        data-amount="{{i.qoldiq}}" 
                                        data-id="{{i.id}}">
                                    To'lov qilish
                                </button>
                            {% else %}
                            <button class="btn btn-sm btn-primary make-payment" 
                            data-month="{{i.month}}" 
                            data-amount="{{i.qoldiq}}" 
                            data-id="{{i.id}}" disabled>
                            Mavjud emas
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
            <!-- Table ends -->

            <!-- Payment Modal -->
            <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="POST">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="paymentModalLabel">To'lov qilish</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="amount" class="col-form-label">Summani kiriting:</label>
                                    <input type="number" class="form-control amountInp" placeholder="To'lov miqdori " name="amount" id="amount" required>
                                    <input type="hidden" name="payment-type" value="monthly">
                                    <input type="hidden" name="debt-id" id="debt-id" class="debtorId">
                                    <input type="hidden" name="max-amount" id="max-amount">
                                    <div id="amountError" class="text-danger mt-1" style="display: none;">
                                        To'lov miqdori oy uchun qoldiqdan oshmasligi kerak
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                                <button type="submit" class="btn btn-primary" id="paymentSubmitBtn" disabled>To'lovni tasdiqlash</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Custom Payment Modal -->
            <div class="modal fade" id="customPaymentModal" tabindex="-1" aria-labelledby="customPaymentModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="POST">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="customPaymentModalLabel">Ixtiyoriy to'lov qilish</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customAmount" class="col-form-label">Summani kiriting:</label>
                                    <input type="number" class="form-control" placeholder="To'lov miqdori" name="customAmount" id="customAmount" required>
                                    <input type="hidden" name="payment-type" value="custom">
                                    <input type="hidden" name="total-remaining" id="custom-total-remaining">
                                    <div id="customAmountError" class="text-danger mt-1" style="display: none;">
                                        To'lov miqdori xonadon uchun qolgan qoldiqdan oshmasligi kerak
                                    </div>
                                    <div id="customMinPaymentError" class="text-danger mt-1" style="display: none;">
                                        To'lov miqdori kamida 1 so'm bo'lishi kerak
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                                <button type="submit" class="btn btn-primary" id="customPaymentSubmitBtn" disabled>To'lovni tasdiqlash</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            </div>
        </div>
        </div>
    </div>
    <!-- Row ends -->

    </div>
    <!-- App body ends -->

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate total remaining balance and find minimum monthly payment
        let totalRemaining = 0;
        
        document.querySelectorAll('tr').forEach(row => {
            const amountCell = row.querySelector('td:nth-child(2)');
            const qoldiqCell = row.querySelector('td:nth-child(4)');
            
            if (amountCell && qoldiqCell) {
                // Get amount for this month
                const amountText = amountCell.textContent;
                const amountValue = parseInt(amountText.replace(/\D/g, ''));
                
                // Get remaining balance for this month
                const qoldiqText = qoldiqCell.textContent;
                const qoldiqValue = parseInt(qoldiqText.replace(/\D/g, ''));
                
                // Update total remaining
                if (!isNaN(qoldiqValue)) {
                    totalRemaining += qoldiqValue;
                }
            }
        });
        
        // Update the total remaining debt display
        document.getElementById('totalRemainingDebt').textContent = new Intl.NumberFormat('ru-RU').format(totalRemaining) + ' so\'m';

        if (totalRemaining <= 0) {
            document.getElementById('customPaymentBtn').disabled = true
        }
        
        // Find the next unpaid month and disable payment buttons for future months
        setupSequentialPayments();
        
        // To'lov qilish tugmalarini tanlash
        const paymentButtons = document.querySelectorAll('.make-payment:not([disabled])');
        
        // Har bir tugma uchun modal ochish
        paymentButtons.forEach(button => {
            button.addEventListener('click', function() {
                const month = this.getAttribute('data-month');
                const amount = this.getAttribute('data-amount');
                const id = this.getAttribute('data-id');
                
                // Modal elementlarini to'ldirish
                document.getElementById('debt-id').value = id;
                document.getElementById('amount').value = amount;
                document.getElementById('max-amount').value = amount;
                
                // Reset error messages
                document.getElementById('amountError').style.display = 'none';
                
                // Validate initial amount and enable/disable submit button
                validatePaymentAmount();
                
                // Modalni ochish
                const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                paymentModal.show();
            });
        });
        
        // Custom payment button functionality
        document.getElementById('customPaymentBtn').addEventListener('click', function() {
            document.getElementById('custom-total-remaining').value = totalRemaining;
            document.getElementById('customAmount').value = '';
            
            // Reset error messages
            document.getElementById('customAmountError').style.display = 'none';
            document.getElementById('customMinPaymentError').style.display = 'none';
            
            // Disable submit button initially
            document.getElementById('customPaymentSubmitBtn').disabled = true;
            
            const customPaymentModal = new bootstrap.Modal(document.getElementById('customPaymentModal'));
            customPaymentModal.show();
        });
        
        // Function to set up sequential payments
        function setupSequentialPayments() {
            const rows = document.querySelectorAll('.payment-row');
            let nextUnpaidMonthFound = false;
            let nextUnpaidMonth = null;
            
            // Sort rows by month number
            const sortedRows = Array.from(rows).sort((a, b) => {
                const monthA = parseInt(a.getAttribute('data-month'));
                const monthB = parseInt(b.getAttribute('data-month'));
                return monthA - monthB;
            });
            
            // Find the next unpaid month
            for (const row of sortedRows) {
                const qoldiq = parseInt(row.getAttribute('data-qoldiq'));
                const month = parseInt(row.getAttribute('data-month'));
                
                // Skip initial payment (month 0)
                if (month === 0) continue;
                
                if (qoldiq > 0 && !nextUnpaidMonthFound) {
                    nextUnpaidMonthFound = true;
                    nextUnpaidMonth = month;
                }
            }
            
            // Disable payment buttons for future months

        }
        
        // Function to validate payment amount and enable/disable submit button
        function validatePaymentAmount() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('max-amount').value);
            const submitBtn = document.getElementById('paymentSubmitBtn');
            
            // Reset error messages
            document.getElementById('amountError').style.display = 'none';
            
            let isValid = true;
            
            // Check if amount exceeds month's remaining balance
            if (amount > maxAmount) {
                document.getElementById('amountError').style.display = 'block';
                isValid = false;
            }
            
            // Enable/disable submit button based on validation
            submitBtn.disabled = !isValid || amount === 0;
        }
        
        // Function to validate custom payment amount and enable/disable submit button
        function validateCustomPaymentAmount() {
            const amount = parseFloat(document.getElementById('customAmount').value) || 0;
            const totalRemaining = parseFloat(document.getElementById('custom-total-remaining').value);
            const submitBtn = document.getElementById('customPaymentSubmitBtn');
            
            // Reset error messages
            document.getElementById('customAmountError').style.display = 'none';
            document.getElementById('customMinPaymentError').style.display = 'none';
            
            let isValid = true;
            
            // Check if amount exceeds total remaining balance
            if (amount > totalRemaining) {
                document.getElementById('customAmountError').style.display = 'block';
                isValid = false;
            }
            
            // Check if amount is less than 1 soum
            if (amount < 1) {
                document.getElementById('customMinPaymentError').style.display = 'block';
                isValid = false;
            }
            
            // Enable/disable submit button based on validation
            submitBtn.disabled = !isValid || amount === 0;
        }
        
        // To'lov miqdorini tekshirish
        document.getElementById('amount').addEventListener('input', validatePaymentAmount);
        
        // Custom to'lov miqdorini tekshirish
        document.getElementById('customAmount').addEventListener('input', validateCustomPaymentAmount);
    });

    function showDebtor(id) {
        let findById = dataa.find(item => item.id === id);
        
        if (findById) {
            // Qarzdorlik summasini ko'rsatish
            document.querySelector("#qarz_amount").textContent = `${Number(findById.residual).toLocaleString("ru-RU")} so'm`;
            
            // Debtor ID ni o'rnatish
            document.querySelector(".debtorId").value = id;
            
            // Modalni ochish
            var modal = new bootstrap.Modal(document.getElementById('exampleModal'));
            modal.show();
        } else {
            console.error("Contract not found");
        }
    } 
</script>

{% endblock item %}