{% extends "base.html" %} {% load static %} {% block title %}Bino ma'lumotlari - Xorazm Elite House{% endblock title %} {% block item %}
<div class="app-container">
  <!-- App hero header starts -->
  <div class="app-hero-header d-flex align-items-center">
    <!-- Breadcrumb starts -->
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
        <a href="/">Asosiy</a>
      </li>
      <li class="breadcrumb-item text-primary" aria-current="page">
        Bino ma'lumotlari
      </li>
    </ol>
    <!-- Breadcrumb ends -->
  </div>
  <!-- App Hero header ends -->

  <!-- App body starts -->
  <div class="app-body">
    <!-- Row starts -->
    <div class="row gx-3">
      <div class="col-xl-12">
        <div class="card">
          <div class="card-body">
            <!-- Tab content starts -->
            <div class="tab-content">
              <div
                class="tab-pane fade show active"
                id="oneA"
                role="tabpanel"
              >
                <!-- Row starts -->
                <div class="row gx-3">
                  <div class="col-xxl-3 col-lg-4 col-sm-6">
                    <div class="mb-3">
                      <label class="form-label" for="company_select"
                        >Kompaniya <span class="text-danger">*</span></label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="ri-building-2-line"></i
                        ></span>
                        <select
                          class="form-select form-select-sm company"
                          id="company_select"
                          name="company_sel"
                        >
                          <option value="">Kompaniyani tanlang</option>
                          {% for i in company %}
                          <option value="{{ i.pk }}">{{ i.name }}</option>
                          {% endfor %}  
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-xxl-3 col-lg-4 col-sm-6">
                    <div class="mb-3">
                      <label class="form-label" for="city_select"
                        >Shahar <span class="text-danger">*</span></label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="ri-map-pin-line"></i
                        ></span>
                        <select
                          class="form-select form-select-sm city"
                          id="city_select"
                          name="city_sel"
                        >
                          <option value="">Shaharni tanlang</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="col-xxl-3 col-lg-4 col-sm-6">
                    <div class="mb-3">
                      <label class="form-label" for="building_select"
                        >Bino <span class="text-danger">*</span></label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="ri-building-line"></i
                        ></span>
                        <select
                          class="form-select form-select-sm bino"
                          id="building_select"
                          name="building_sel"
                        >
                          <option value="">Binoni tanlang</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="col-xxl-3 col-lg-4 col-sm-6">
                    <div class="mb-3">
                      <label class="form-label" for="a1"
                        >Bino holati</label
                      >
                      <div class="input-group">
                        <span class="input-group-text"
                          ><i class="ri-information-line"></i
                        ></span>
                        <input
                          type="text"
                          class="form-control building_status"
                          disabled
                          placeholder="Bino holati"
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row gx-3 mt-4">
                  <div class="col-12">
                    <div class="card mb-4">
                      <div class="card-header">
                        <h5 class="card-title mb-0">Tanlangan uy ma'lumotlari</h5>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Padez raqami</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-door-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control padez_number"
                                  disabled
                                  placeholder="Padez raqami"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Qavat raqami</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-stack-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control home_floor"
                                  disabled
                                  placeholder="Qavat raqami"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Maydoni (kv/m)</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-ruler-2-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control mkv"
                                  disabled
                                  placeholder="Maydon"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">1 kv/m narxi</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-money-dollar-circle-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control price"
                                  disabled
                                  placeholder="Narx"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Umumiy narxi</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-money-dollar-box-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control allprice"
                                  disabled
                                  placeholder="Umumiy narx"
                                />
                              </div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Holati</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-checkbox-circle-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control home_status"
                                  disabled
                                  placeholder="Holati"
                                />
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row mt-3 client-info" style="display: none;">
                          <div class="col-12">
                            <h6 class="mb-3">Mijoz ma'lumotlari</h6>
                          </div>
                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Mijoz to'liq ismi</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-user-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control client_name"
                                  disabled
                                  placeholder="Mijoz ismi"
                                />
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Telefon raqami</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-phone-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control client_phone"
                                  disabled
                                  placeholder="Telefon raqami"
                                />
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4">
                            <div class="mb-3">
                              <label class="form-label">Passport raqami</label>
                              <div class="input-group">
                                <span class="input-group-text">
                                  <i class="ri-passport-line"></i>
                                </span>
                                <input
                                  type="text"
                                  class="form-control client_passport"
                                  disabled
                                  placeholder="Passport raqami"
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row gx-3">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header">
                        <h5 class="card-title mb-0">Bino tarkibi</h5>
                      </div>
                      <div class="card-body">
                        <div id="building-structure" class="mt-3">
                          <div class="alert alert-info">
                            Binoni tanlang va bino tarkibi shu yerda ko'rsatiladi
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Row ends -->
  </div>
  <!-- App body ends -->
</div>

<style>
  .floor-block {
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    background-color: #f8f9fa;
  }

  .floor-title {
    font-weight: 600;
    margin-bottom: 15px;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
  }

  .padez-block {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .padez-title {
    font-weight: 500;
    margin-bottom: 10px;
    color: #6c757d;
  }

  .home-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .home-button {
    min-width: 80px;
    text-align: center;
    transition: all 0.2s;
  }

  .home-button:hover:not(:disabled) {
    transform: translateY(-2px);
  }

  .home-button.selected {
    box-shadow: 0 0 0 2px #0d6efd;
  }

  .home-button.busy {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
  }

  .home-button.available {
    background-color: #fff;
    border-color: #0d6efd;
    color: #0d6efd;
  }
</style>

<script>
  // Elementlarni tanlash
  const citySelect = document.querySelector('.city');
  const buildingSelect = document.querySelector('.bino');
  const companySelect = document.querySelector('.company');
  const buildingStructure = document.getElementById('building-structure');
  
  // Form fields
  const padezNumberField = document.querySelector('.padez_number');
  const homeFloorField = document.querySelector('.home_floor');
  const mkvField = document.querySelector('.mkv');
  const priceField = document.querySelector('.price');
  const allPriceField = document.querySelector('.allprice');
  const homeStatusField = document.querySelector('.home_status');
  const buildingStatusField = document.querySelector('.building_status');
  
  // Client info fields
  const clientInfoSection = document.querySelector('.client-info');
  const clientNameField = document.querySelector('.client_name');
  const clientPhoneField = document.querySelector('.client_phone');
  const clientPassportField = document.querySelector('.client_passport');
  
  // Data from Django context
  const data = {{ result|safe }};
  const buildingInfo = data.building;
  const cityInfo = data.city;
  const homeInfo = data.home;
  const clientInfo = data.client;
  
  // Format number with commas for better readability
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  
  // Clear all form fields
  function clearFormFields() {
    padezNumberField.value = '';
    homeFloorField.value = '';
    mkvField.value = '';
    priceField.value = '';
    allPriceField.value = '';
    homeStatusField.value = '';
    clientNameField.value = '';
    clientPhoneField.value = '';
    clientPassportField.value = '';
    clientInfoSection.style.display = 'none';
  }
  
  // Company selection handler
  companySelect.addEventListener("change", () => {
    const selectedCompanyId = companySelect.value;
    
    // Clear all dependent fields
    citySelect.innerHTML = '<option value="">Shaharni tanlang</option>';
    buildingSelect.innerHTML = '<option value="">Binoni tanlang</option>';
    buildingStructure.innerHTML = '<div class="alert alert-info">Binoni tanlang va bino tarkibi shu yerda ko\'rsatiladi</div>';
    buildingStatusField.value = '';
    clearFormFields();
    
    if (!selectedCompanyId) return;
  
    const companyId = parseInt(selectedCompanyId, 10);
    
    // Filter cities by company
    const filteredCities = cityInfo.filter(city => city.company === companyId);
    
    if (filteredCities.length === 0) {
      citySelect.innerHTML = '<option value="">Shaharlar mavjud emas</option>';
    } else {
      citySelect.innerHTML = '<option value="">Shaharni tanlang</option>';
      filteredCities.forEach(city => {
        const option = document.createElement('option');
        option.value = city.id;
        option.textContent = city.name;
        citySelect.appendChild(option);
      });
    }
  });
  
  // City selection handler
  citySelect.addEventListener("change", () => {
    const selectedCityId = citySelect.value;
    
    // Clear dependent fields
    buildingSelect.innerHTML = '<option value="">Binoni tanlang</option>';
    buildingStructure.innerHTML = '<div class="alert alert-info">Binoni tanlang va bino tarkibi shu yerda ko\'rsatiladi</div>';
    buildingStatusField.value = '';
    clearFormFields();
    
    if (!selectedCityId) return;
    
    const cityId = parseInt(selectedCityId, 10);
    
    // Filter buildings by city
    const filteredBuildings = buildingInfo.filter(building => building.city === cityId);
    
    if (filteredBuildings.length === 0) {
      buildingSelect.innerHTML = '<option value="">Binolar mavjud emas</option>';
    } else {
      buildingSelect.innerHTML = '<option value="">Binoni tanlang</option>';
      filteredBuildings.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        buildingSelect.appendChild(option);
      });
    }
  });
  
  // Building selection handler
  buildingSelect.addEventListener('change', function() {
    const selectedBuildingId = this.value;
    
    // Clear previous data
    buildingStructure.innerHTML = '';
    buildingStatusField.value = '';
    clearFormFields();
    
    if (!selectedBuildingId) {
      buildingStructure.innerHTML = '<div class="alert alert-info">Binoni tanlang va bino tarkibi shu yerda ko\'rsatiladi</div>';
      return;
    }
    
    const buildingId = parseInt(selectedBuildingId, 10);
    
    // Find selected building
    const selectedBuilding = buildingInfo.find(building => building.id === buildingId);
    
    if (!selectedBuilding) {
      buildingStructure.innerHTML = '<div class="alert alert-warning">Bino ma\'lumotlari topilmadi</div>';
      return;
    }
    
    // Set building status
    buildingStatusField.value = selectedBuilding.status === "true" ? "Faol" : "Faol emas";
    
    // Filter homes by building
    const homesInBuilding = homeInfo.filter(home => home.building === buildingId);
    
    if (homesInBuilding.length === 0) {
      buildingStructure.innerHTML = '<div class="alert alert-warning">Bu binoda uylar mavjud emas</div>';
      return;
    }
    
    // Group homes by padez (entrance)
    const padezGroups = {};
    homesInBuilding.forEach(home => {
      const padezNumber = home.padez_number;
      if (!padezGroups[padezNumber]) {
        padezGroups[padezNumber] = [];
      }
      padezGroups[padezNumber].push(home);
    });
    
    // Sort padez numbers
    const sortedPadezNumbers = Object.keys(padezGroups).sort((a, b) => parseInt(a) - parseInt(b));
    
    // Create structure for each padez
    sortedPadezNumbers.forEach(padezNumber => {
      const padezDiv = document.createElement('div');
      padezDiv.classList.add('floor-block');
      
      const padezTitle = document.createElement('h5');
      padezTitle.classList.add('floor-title');
      padezTitle.textContent = `Padez ${padezNumber}`;
      padezDiv.appendChild(padezTitle);
      
      // Group homes by floor within this padez
      const floorGroups = {};
      padezGroups[padezNumber].forEach(home => {
        const floorNumber = home.home_floor;
        if (!floorGroups[floorNumber]) {
          floorGroups[floorNumber] = [];
        }
        floorGroups[floorNumber].push(home);
      });
      
      // Sort floor numbers in ascending order (starting from floor 1)
      const sortedFloorNumbers = Object.keys(floorGroups).sort((a, b) => parseInt(a) - parseInt(b));
      
      // Create structure for each floor
      sortedFloorNumbers.forEach(floorNumber => {
        const floorDiv = document.createElement('div');
        floorDiv.classList.add('padez-block');
        
        const floorTitle = document.createElement('h6');
        floorTitle.classList.add('padez-title');
        floorTitle.textContent = `${floorNumber}-qavat`;
        floorDiv.appendChild(floorTitle);
        
        const homeButtonsDiv = document.createElement('div');
        homeButtonsDiv.classList.add('home-buttons');
        
        // Sort homes by home number
        const sortedHomes = floorGroups[floorNumber].sort((a, b) => 
          parseInt(a.home_number) - parseInt(b.home_number)
        );
        
        // Create button for each home
        sortedHomes.forEach(home => {
          const button = document.createElement('button');
          button.type = 'button';
          button.classList.add('btn', 'home-button');
          button.dataset.homeId = home.id;
          button.dataset.homeNumber = home.home_number;
          button.dataset.padezNumber = home.padez_number;
          button.dataset.homeFloor = home.home_floor;
          button.dataset.field = home.field;
          button.dataset.price = home.price;
          button.dataset.busy = home.busy;
          
          // Set button text and style based on status
          button.textContent = `Uy #${home.home_number}`;
          
          if (home.busy === "true") {
            button.classList.add('busy');
          } else {
            button.classList.add('available');
          }
          
          homeButtonsDiv.appendChild(button);
        });
        
        floorDiv.appendChild(homeButtonsDiv);
        padezDiv.appendChild(floorDiv);
      });
      
      buildingStructure.appendChild(padezDiv);
    });
  });
  
  // Home selection handler
  document.addEventListener('click', function(event) {
    // Check if clicked element is a home button
    if (event.target.classList.contains('home-button')) {
      // Remove selected class from all buttons
      document.querySelectorAll('.home-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Add selected class to clicked button
      event.target.classList.add('selected');
      
      // Get home data from button dataset
      const homeData = event.target.dataset;
      
      // Update form fields with home data
      padezNumberField.value = homeData.padezNumber;
      homeFloorField.value = homeData.homeFloor;
      mkvField.value = homeData.field;
      priceField.value = formatNumber(homeData.price);
      
      // Calculate and display total price
      const totalPrice = parseFloat(homeData.field) * parseFloat(homeData.price);
      allPriceField.value = formatNumber(totalPrice);
      
      // Set home status
      homeStatusField.value = homeData.busy === "true" ? "Sotilgan" : "Sotuvda";
      
      // If home is sold, show client info
      if (homeData.busy === "true") {
        // Find client for this home
        const client = clientInfo.find(c => 
          c.building === parseInt(buildingSelect.value) && 
          c.home_number === homeData.homeNumber
        );
        
        if (client) {
          clientNameField.value = client.client_name;
          clientPhoneField.value = client.client_phone;
          clientPassportField.value = client.client_passport;
          clientInfoSection.style.display = 'block';
        } else {
          clientInfoSection.style.display = 'none';
        }
      } else {
        clientInfoSection.style.display = 'none';
      }
    }
  });
  </script>

{% endblock item %}